TWAPI_SRCROOT = $(MAKEDIR)\..
!include ..\common.inc

!ifndef PACKAGE
!error Macro PACKAGE is not defined.
!endif

!ifndef PACKAGEDIR
PACKAGEDIR=$(TWAPI_SRCROOT)\dist
!endif

# Must have files
BASE_TCLFILES=win32calls.tcl twapi.tcl osinfo.tcl security.tcl process.tcl disk.tcl

# Desktop files
DESKTOP_TCLFILES= ui.tcl clipboard.tcl nls.tcl shell.tcl com.tcl

# Server files
SERVER_TCLFILES= services.tcl eventlog.tcl

# Files for full build
EXTRA_TCLFILES= \
	pdh.tcl process2.tcl accounts.tcl share.tcl \
        network.tcl console.tcl synch.tcl desktop.tcl \
        printer.tcl mstask.tcl msi.tcl crypto.tcl \
        device.tcl power.tcl

TCLFILES = $(BASE_TCLFILES)

!IFNDEF DESKTOPONLY
TCLFILES = $(TCLFILES) $(SERVER_TCLFILES)
!ENDIF

!IFNDEF SERVERONLY
TCLFILES = $(TCLFILES) $(DESKTOP_TCLFILES)
!ENDIF

!IFNDEF LEAN
TCLFILES = $(TCLFILES) $(EXTRA_TCLFILES)
!ENDIF

!if "x$(PACKAGESTYLE)" == "xtm"
# Note tm package style has no pkgIndex.tcl file
distribution: twapi_version.tcl twapi_buildinfo.tcl $(TCLFILES)
        -@mkdir "$(PACKAGEDIR)"
        !@copy $** "$(PACKAGEDIR)"
	del twapi_buildinfo.tcl
!else
distribution: pkgIndex.tcl twapi_version.tcl twapi_buildinfo.tcl $(TCLFILES)
        -@mkdir "$(PACKAGEDIR)"
        !@copy $** "$(PACKAGEDIR)"
	del twapi_buildinfo.tcl
!endif


twapi_version.tcl : ../common.inc
        echo <<$@
# This file is automatically generated and will be overwritten
namespace eval twapi {
    variable version $(MODULEMAJOR).$(MODULEMINOR)
    variable patchlevel $(MODULEVERSION)
}
<<KEEP

twapi_buildinfo.tcl : 
        echo <<$@
# This file is automatically generated and will be overwritten
namespace eval twapi {
    variable package_name $(PACKAGE)
    if {$$::tcl_platform(machine) eq "amd64"} {
        variable dll_base_name $(PACKAGE)64
    } else {
        variable dll_base_name $(PACKAGE)
    }
}
# The build_id is generated automatically on every build
<<KEEP
        echo puts "set twapi::build_id [clock seconds]" | $(TCLSH) >> $@

makefile: ../common.inc

clean:
        -del *.*~
        -del tcl_version.tcl
        -rmdir/s/q dist

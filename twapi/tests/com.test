#
# Copyright (c) 2006-2010, Ashok P. Nadkarni
# All rights reserved.
#
# See the file LICENSE for license

# This file contains tests for commands from the com.tcl

package require tcltest
eval tcltest::configure $argv

source [file join [file dirname [info script]] testutil.tcl]
load_twapi

namespace eval twapi::com::test {
    namespace import ::tcltest::test
    ::tcltest::testConstraint win2k [twapi::min_os_version 5]

    variable shell_clsid {{13709620-C279-11CE-A49E-444553540000}}
    variable shell_progid Shell.Application
    variable ie_clsid {{0002DF01-0000-0000-C000-000000000046}}
    variable ie_quit_delay 100;   # Ms Delay before calling IE Quit to avoid hang

    ################################################################

    test comobj-1.0 {
        Create COM object using progid
    } -constraints {
        nt
    } -body {
        [twapi::comobj $shell_progid] -destroy
    } -result ""

    ###

    test comobj-1.1 {
        Create COM object using clsid
    } -constraints {
        nt
    } -body {
        [twapi::comobj $shell_clsid] -destroy
    } -result ""

    ###

    test comobj-2.0 {
        Create COM object with -disablelog true
    } -constraints {
        nt
    } -body {
        [twapi::comobj $shell_clsid -disablelog true] -destroy
    } -result ""

    ###

    test comobj-2.1 {
        Create COM object with -disablelog false
    } -constraints {
        nt
    } -body {
        [twapi::comobj $shell_clsid -disablelog false] -destroy
    } -result ""

    ###

    test comobj-3.0 {
        Create COM object with -download true
    } -constraints {
        nt
    } -body {
        [twapi::comobj $shell_clsid -download true] -destroy
    } -result ""

    ###

    test comobj-3.1 {
        Create COM object with -download false
    } -constraints {
        nt
    } -body {
        [twapi::comobj $shell_clsid -download false] -destroy
    } -result ""

    ###

    test comobj-4.0 {
        Create COM object with -enableaaa true
    } -constraints {
        nt
    } -body {
        [twapi::comobj $shell_clsid -enableaaa true] -destroy
    } -result ""

    ###

    test comobj-4.1 {
        Create COM object with -enableaaa false
    } -constraints {
        nt
    } -body {
        [twapi::comobj $shell_clsid -enableaaa false] -destroy
    } -result ""

    ###

    test comobj-5.0 {
        Create COM object with -model any
    } -constraints {
        nt
    } -body {
        [twapi::comobj $shell_clsid -model any] -destroy
    } -result ""

    ###

    test comobj-5.1 {
        Create COM object with -model inprocserver
    } -constraints {
        nt
    } -body {
        [twapi::comobj $shell_clsid -model inprocserver] -destroy
    } -result ""

    ###

    test comobj-5.2 {
        Create COM object with -model localserver
    } -constraints {
        nt
    } -body {
        set ie [twapi::comobj $ie_clsid -model localserver]
        after $ie_quit_delay;        # Delay before quitting else IE 8 hangs
        $ie Quit
        $ie -destroy
    } -result ""

    ###

    test comobj-5.3 {
        Create COM object with -model remoteserver
    } -constraints {
        nt TBD
    } -body {
    } -result ""

    ###

    test comobj-5.4 {
        Create COM object with -model inprochandler
    } -constraints {
        nt TBD
    } -body {
    } -result ""

    ###

    test comobj-6.0 {
        Create COM object with -nocustommarshal true
    } -constraints {
        TBD nt
    } -body {
        need to find a COM object that supports this
        [twapi::comobj PROGID -nocustommarshal true] -destroy
    } -result ""

    ###

    test comobj-6.1 {
        Create COM object with -nocustommarshal false
    } -constraints {
        nt
    } -body {
        [twapi::comobj $shell_clsid -nocustommarshal false] -destroy
    } -result ""


    test comobj-7.0 {
        Get default property value of a COM object
    } -constraints {
        nt
    } -setup {
        set ie [twapi::comobj InternetExplorer.Application]
    } -cleanup {
        after $ie_quit_delay;        # Delay before quitting else IE 8 hangs
        $ie Quit
        $ie -destroy
    } -body {
        $ie -default
    } -result "* Internet Explorer" -match glob 

    ###

    test comobj-8.0 {
        Get comobj implicit property
    } -constraints {
        nt
    } -setup {
        set wscript [twapi::comobj wscript.shell]
    } -cleanup {
        $wscript -destroy
    } -body {
        file normalize [$wscript CurrentDirectory]
    } -result [pwd]

    ###

    test comobj-8.1 {
        Put comobj implicit property
    } -constraints {
        nt
    } -setup {
        set prevdir [pwd]
        set wscript [twapi::comobj wscript.shell]
    } -cleanup {
        $wscript -destroy
        cd $prevdir
    } -body {
        $wscript CurrentDirectory c:/
        string tolower [pwd]
    } -result c:/

    ###

    test comobj-8.2 {
        Invoke comobj implicit method
    } -constraints {
        nt
    } -setup {
        set wscript [twapi::comobj wscript.shell]
    } -cleanup {
        $wscript -destroy
    } -body {
        $wscript ExpandEnvironmentStrings %username%
    } -result $::env(username)

    ###

    test comobj-9.0 {
        Bind scripts to comobj events using -bind
    } -constraints {
        nt TBD
    } -setup {
    } -cleanup {
    } -body {
    } -result TBD


    ###

    test comobj-10.0 {
        Invoke comobj method using -call
    } -constraints {
        nt
    } -setup {
        set wscript [twapi::comobj wscript.shell]
    } -cleanup {
        $wscript -destroy
    } -body {
        $wscript -call ExpandEnvironmentStrings %username%
    } -result $::env(username)

    ###

    test comobj-11.0 {
        Destroy comobj
    } -constraints {
        nt
    } -body {
        set wscript [twapi::comobj wscript.shell]
        $wscript -destroy
        llength [info commands $wscript]
    } -result 0

    ###

    test comobj-12.0 {
        Get comobj property using -get
    } -constraints {
        nt
    } -setup {
        set wscript [twapi::comobj wscript.shell]
    } -cleanup {
        $wscript -destroy
    } -body {
        file normalize [$wscript -get CurrentDirectory]
    } -result [pwd]

    ###

    test comobj-13.0 {
        Get comobj interface using -proxy
    } -constraints {
        nt
    } -setup {
        set wscript [twapi::comobj wscript.shell]
    } -cleanup {
        $wscript -destroy
    } -body {
        # Interface should be an IDispatch so try calling one of its methods
        [$wscript -proxy] GetTypeInfoCount
    } -result 1

    ###

    test comobj-14.0 {
        Iterate over a comobj collection using -iterate
    } -constraints {
        nt
    } -setup {
        set fso [twapi::comobj Scripting.FileSystemObject]
        set drive_coll [$fso Drives]
    } -cleanup {
        $drive_coll -destroy
        $fso -destroy
    } -body {
        set drives [list ]
        $drive_coll -iterate drive_obj {
            lappend drives [$drive_obj DriveLetter]
        }
        llength $drives
    } -result [llength [twapi::get_logical_drives]]

    ###

    test comobj-15.0 {
        Get a interface from a comobj using -interface
    } -constraints {
        nt
    } -setup {
        set wscript [twapi::comobj wscript.shell]
    } -cleanup {
        $wscript -destroy
    } -body {
        twapi::IUnknown_Release [$wscript -interface]
        # There is one ref left from the wscript.shell object itself
    } -result 1

    ###

    test comobj-16.0 {
        Put comobj property using -put
    } -constraints {
        nt
    } -setup {
        set prevdir [pwd]
        set wscript [twapi::comobj wscript.shell]
    } -cleanup {
        $wscript -destroy
        cd $prevdir
    } -body {
        $wscript -set CurrentDirectory c:/
        string tolower [pwd]
    } -result c:/

    ###

    test comobj-17.0 {
        Unbind scripts from comobj events using -unbind
    } -constraints {
        nt TBD
    } -setup {
    } -cleanup {
    } -body {
    } -result ""

    ###

    test comobj-18.0 {
        Navigate comobj hierarchy using -with
    } -constraints {
        nt TBD
    } -setup {
    } -cleanup {
    } -body {
    } -result ""


    ################################################################

    test variant_time_to_timelist-1.0 {
        Convert variant time to a time list
    } -constraints {
        nt
    } -body {
        twapi::variant_time_to_timelist 2.0
    } -result "1900 1 1 0 0 0 0"

    ################################################################

    test timelist_to_variant_time-1.0 {
        Convert time list to a variant time
    } -constraints {
        nt
    } -body {
        twapi::timelist_to_variant_time  "1900 1 1 0 0 0 0"
    } -result 2.0



    ################################################################

    test variant_param_passing-1.0 {
        Test variant parameter of type int are passed correctly
    } -setup {
        set sh [twapi::comobj Shell.Application]
    } -body {
        # The param is a variant that may be a integer
        # corresponding to a special folder or a string path
        set fo [$sh NameSpace 36]
        $fo Title
    } -cleanup {
        $fo -destroy
        $sh -destroy
    } -result WINDOWS

    test variant_param_passing-1.1 {
        Test variant parameter of type string are passed correctly
    } -setup {
        set sh [twapi::comobj Shell.Application]
    } -body {
        # The param is a variant that may be a integer
        # corresponding to a special folder or a string path
        set fo [$sh NameSpace [file nativename [pwd]]]
        $fo Title
    } -cleanup {
        $fo -destroy
        $sh -destroy
    } -result [file tail [pwd]]

    test variant_param_passing-1.2 {
        Test variant parameter of type dispatch are passed correctly
    } -setup {
        set sh [twapi::comobj Shell.Application]
        set dir [tcltest::makeDirectory [clock clicks]]
        set path [tcltest::makeFile "" [clock clicks]]; # Makes file in temp dir
        set source_folder_obj [$sh NameSpace [file nativename [tcltest::temporaryDirectory]]]
        set source_file_obj [$source_folder_obj ParseName [file tail $path]]
        set ifc [$source_file_obj -interface]
        set target_folder_obj [$sh NameSpace [file nativename $dir]]
    } -body {
        # The param is a variant that may be a integer
        # corresponding to a special folder or a string path
        # or (in this case) a folder object
        $target_folder_obj CopyHere $ifc
        file exists [file join $dir [file tail $path]]
    } -cleanup {
        twapi::IUnknown_Release $ifc
        $source_file_obj -destroy
        $source_folder_obj -destroy
        $target_folder_obj -destroy
        $sh -destroy
    } -result 1

    test variant_param_passing-2.0 {
        Test variant parameter of type variant*
    } -constraints {
        userInteraction
    } -setup {
        set ie [twapi::comobj InternetExplorer.Application]
    } -body {
        # The first parameter is passed as bstr variant*
        # The second parameter "1" is passed as int variant*
        $ie Visible 1
        $ie Navigate http://www.google.com 1
        after 100;              # Give it a chance
        yesno "Did you see two Internet Explorer windows, at least one to google (The google window *may* have to be closed manually) ?"
    } -cleanup {
        $ie Quit
        $ie -destroy
        # The second window remains so close it
        set iewin [lindex [twapi::find_windows -text "Google*" -match glob -toplevel 1] 0]
        if {$iewin ne ""} {
            twapi::close_window $iewin
        }
    } -result 1

    ################################################################

    ::tcltest::cleanupTests
}

namespace delete ::twapi::com::test

#
# Copyright (c) 2013, Ashok P. Nadkarni
# All rights reserved.
#
# See the file LICENSE for license

# This file contains tests for basic operation

package require tcltest
eval tcltest::configure $argv

source [file join [file dirname [info script]] testutil.tcl]
load_twapi_package twapi_base

#
# Set up system-specific constants that are used to match test results
namespace eval twapi::base::test {
    namespace import ::tcltest::test

    test record-1.0 {
        record basic test
    } -body {
        set r [uplevel #0 [list twapi::record reccmd {a b c}]]
    } -cleanup {
        rename $r {}
    } -result ::reccmd

    test record-1.1 {
        record basic test (unnamed)
    } -body {
        set r [uplevel #0 [list twapi::record {a b c}]]
    } -cleanup {
        rename $r {}
    } -result ::record* -match glob

    test record-1.2 {
        record basic test namespace
    } -body {
        set r [twapi::record reccmd {a b c}]
    } -cleanup {
        rename $r {}
    } -result ::twapi::base::test::reccmd

    test record-1.3 {
        record basic test (unnamed)
    } -body {
        set r [twapi::record {a b c}]
    } -cleanup {
        rename $r {}
    } -result ::twapi::base::test::record* -match glob

    test record-1.4 {
        record basic test namespace
    } -body {
        set r [twapi::record ::reccmd {a b c} ]
    } -cleanup {
        rename $r {}
    } -result ::reccmd

    test record-1.5 {
        record basic test namespace empty definition
    } -body {
        twapi::record reccmd {}
    } -returnCodes error -result "empty record definition"

    test record-2.0 {
        Record get first field
    } -setup {
        set r [twapi::record {a b c}]
    } -body {
        $r a {{0 1} 2 3}
    } -cleanup {
        rename $r {}
    } -result {0 1}

    test record-2.1 {
        Record get last field
    } -setup {
        set r [twapi::record {a b c}]
    } -body {
        $r c {1 2 3}
    } -cleanup {
        rename $r {}
    } -result 3

    test record-2.2 {
        Record get non-existing field
    } -setup {
        set r [twapi::record {a b c}]
    } -body {
        $r d {1 2 3}
    } -cleanup {
        rename $r {}
    } -returnCodes error -result "Invalid enum d"

    test record-2.3 {
        Record get field from truncated record
    } -setup {
        set r [twapi::record {a b c}]
    } -body {
        $r b {1 2}
    } -cleanup {
        rename $r {}
    } -result 2

    test record-2.4 {
        Record get field from truncated record (fail)
    } -setup {
        set r [twapi::record {a b c}]
    } -body {
        $r c {1 2}
    } -cleanup {
        rename $r {}
    } -returnCodes error -result "too few values in record"

    test record-2.5 {
        Record get field from empty record (fail)
    } -setup {
        set r [twapi::record {a b c}]
    } -body {
        $r a {}
    } -cleanup {
        rename $r {}
    } -returnCodes error -result "too few values in record"

    test record-2.6 {
        Record get explicit command
    } -setup {
        set r [twapi::record {a b c}]
    } -body {
        $r get {1 2 3} c
    } -cleanup {
        rename $r {}
    } -result 3

    test record-3.0 {
        Record get definition
    } -setup {
        set r [twapi::record {a b c}]
    } -body {
        $r
    } -cleanup {
        rename $r {}
    } -result {a b c}

    test record-4.0 {
        Record get dict
    } -setup {
        set r [twapi::record {a b c}]
    } -body {
        $r {1 2 3}
    } -cleanup {
        rename $r {}
    } -result {a 1 b 2 c 3}

    test record-5.0 {
        Record set first field
    } -setup {
        set r [twapi::record {a b c}]
    } -body {
        $r set {1 2 3} a 4
    } -cleanup {
        rename $r {}
    } -result {4 2 3}

    test record-5.1 {
        Record set last field
    } -setup {
        set r [twapi::record {a b c}]
    } -body {
        $r set  {1 2 3} c 0
    } -cleanup {
        rename $r {}
    } -result {1 2 0}

    test record-5.2 {
        Record set non-existing field
    } -setup {
        set r [twapi::record {a b c}]
    } -body {
        $r set {1 2 3} d 4
    } -cleanup {
        rename $r {}
    } -returnCodes error -result "Invalid enum d"

    test record-5.3 {
        Record set field in truncated record
    } -setup {
        set r [twapi::record {a b c}]
    } -body {
        $r set {1 2} b 0
    } -cleanup {
        rename $r {}
    } -result {1 0}

    test record-5.4 {
        Record set field in truncated record (fail)
    } -setup {
        set r [twapi::record {a b c}]
    } -body {
        $r set {1 2} c 4
    } -cleanup {
        rename $r {}
    } -returnCodes error -result "too few values in record"

    test record-6.0 {
        Invalid record subcommand
    } -setup {
        set r [twapi::record {a b c}]
    } -body {
        $r foo {1 2 3} c
    } -cleanup {
        rename $r {}
    } -returnCodes error -result "bad command \"foo\": must be get, set, or select"

    test record-7.0 {
        Select single field
    } -setup {
        set r [twapi::record {a b c}]
    } -body {
        $r select {{w x} y z} a
    } -cleanup {
        rename $r {}
    } -result {{w x}}

    test record-7.1 {
        Select all fields (also non-alpha field name)
    } -setup {
        set r [twapi::record {a b {c d}}]
    } -body {
        $r select {{w x} y z} {a b {c d}}
    } -cleanup {
        rename $r {}
    } -result {{w x} y z}

    test record-7.2 {
        Select subset fields
    } -setup {
        set r [twapi::record {a b c}]
    } -body {
        $r select {{w x} y z} {a c}
    } -cleanup {
        rename $r {}
    } -result {{w x} z}

    test record-7.3 {
        Select non-existing field
    } -setup {
        set r [twapi::record {a b c}]
    } -body {
        $r select {1 2 3} {a d}
    } -cleanup {
        rename $r {}
    } -returnCodes error -result "Invalid enum d"

    test record-7.4 {
        Select repeating fields
    } -setup {
        set r [twapi::record {a b c}]
    } -body {
        $r select {{w x} y z} {a c a}
    } -cleanup {
        rename $r {}
    } -result {{w x} z {w x}}

    test record-7.5 {
        Select with extra args
    } -setup {
        set r [twapi::record {a b c}]
    } -body {
        $r select {1 2 3} a b
    } -cleanup {
        rename $r {}
    } -returnCodes error -result "wrong # args*" -match glob

    test record-7.6 {
        Select empty
    } -setup {
        set r [twapi::record {a b c}]
    } -body {
        $r select {{w x} y z} {}
    } -cleanup {
        rename $r {}
    } -result {}

    test record-7.7 {
        Select from truncated record
    } -setup {
        set r [twapi::record {a b c}]
    } -body {
        $r select {1 2} {b a}
    } -cleanup {
        rename $r {}
    } -result {2 1}

    test record-7.8 {
        Select from truncated record
    } -setup {
        set r [twapi::record {a b c}]
    } -body {
        $r select {1 2} {b c}
    } -cleanup {
        rename $r {}
    } -returnCodes error -result "too few values in record"

}

::tcltest::cleanupTests
namespace delete ::twapi::base::test

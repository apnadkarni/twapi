#
# Copyright (c) 2004-2010, Ashok P. Nadkarni
# All rights reserved.
#
# See the file LICENSE for license

# This file contains tests for commands from the uitcl

package require tcltest
eval tcltest::configure $argv

source [file join [file dirname [info script]] testutil.tcl]
load_twapi_package

namespace eval twapi::ui::test {
    namespace import ::tcltest::test

    # Timeout when ending processes
    set end_process_timeout 5000

    # Offset from window edge to system menu or close buttons
    if {[twapi::min_os_version 6]} {
        set button_edge_offset 10
    } else {
        set button_edge_offset 5
    }

    proc hotkey_test {hk} {
        set ::twapi_test_hotkey_result fail

        set id [twapi::register_hotkey $hk "set ::twapi_test_hotkey_result success"]
        twapi::trap {
            set after_id [after 15000 "set ::twapi_test_hotkey_result timeout"]
            puts "Please press [string toupper $hk] within 15 seconds"
            vwait ::twapi_test_hotkey_result
            after cancel $after_id
        } finally {
            twapi::unregister_hotkey $id
        }
        return $::twapi_test_hotkey_result
    }

    # script1 and script2  must set ::$globalvar !
    proc hotkey_test_append {hk globalvar script1 script2 append} {
        set id [twapi::register_hotkey $hk $script1]
        twapi::trap {
            if {$append eq "append"} {
                twapi::register_hotkey $hk $script2 -append
            } else {
                twapi::register_hotkey $hk $script2
            }
            set after_id [after 15000 "set ::$globalvar timeout"]
            puts "Please press [string toupper $hk] within 15 seconds"
            vwait ::$globalvar
            after cancel $after_id
        } finally {
            twapi::unregister_hotkey $id
        }
    }

   ################################################################

    test get_toplevel_windows-1.0 {
        Get toplevel windows
    } -constraints {
        nt
    } -body {
        expr {[llength [twapi::get_toplevel_windows]] > 0}
    } -result 1

    ################################################################

    test get_toplevel_windows-1.1 {
        Get toplevel windows - invalid options
    } -constraints {
        nt
    } -body {
        twapi::get_toplevel_windows -nosuchoption badarg
    } -returnCodes {error} -match glob -result *

    ################################################################

    test get_toplevel_windows-2.0 {
        Get toplevel windows for a process (pid)
    } -constraints {
        nt
    } -body {
        expr {[llength [twapi::get_toplevel_windows -pid [get_explorer_pid]]] > 0}
    } -result 1

    ################################################################

    test get_toplevel_windows-2.1 {
        Get toplevel windows for a non-existent process (pid)
    } -constraints {
        nt
    } -body {
        llength [twapi::get_toplevel_windows -pid 12000]
    } -result 0

    ################################################################

    test get_toplevel_windows-3.0 {
        Get toplevel windows for a process (name)
    } -constraints {
        nt
    } -body {
        expr {[llength [twapi::get_toplevel_windows -pid explorer.exe]] > 0}
    } -result 1

    ################################################################

    test get_toplevel_windows-3.1 {
        Get toplevel windows for a non-existent process (name)
    } -constraints {
        nt
    } -body {
        llength [twapi::get_toplevel_windows -pid nosuchprocess.exe]
    } -result 0

    ################################################################

    test find_windows-1.0 {
        Find windows (no arguments)
    } -constraints {
        nt
    } -body {
        expr {[llength [twapi::find_windows]] > 0}
    } -result 1

    ################################################################

    test find_windows-1.1 {
        Find windows (invalid arguments)
    } -constraints {
        nt
    } -body {
        twapi::find_windows -nosuchoption badarg
    } -returnCodes {error} -match glob -result *

    ################################################################

    test find_windows-2.0 {
        Find first matching window (-single)
    } -constraints {
        nt
    } -body {
        twapi::Twapi_IsPtr [twapi::find_windows -single]
    } -result 1


    ################################################################

    test find_windows-3.0 {
        Find windows with a specified ancestor
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
    } -body {
        set np_top [notepad_top $np_pid]
        expr {[llength [twapi::find_windows -ancestor $np_top]] > 0}
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test find_windows-3.1 {
        Find windows with a specified ancestor
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_top [notepad_top $np_pid]
    } -body {
        expr {[llength [twapi::find_windows -ancestor $np_top]] > 0}
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test find_windows-3.2 {
        Find windows with a specified ancestor (empty)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_top [notepad_top $np_pid]
        set np_child [lindex [twapi::find_windows -ancestor $np_top] 0]
    } -body {
        twapi::find_windows -ancestor $np_child
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result ""

    ################################################################

    test find_windows-4.0 {
        Verify -caption true and -caption false are exclusive and encompassing
    } -constraints {
        nt
    } -body {
        set all    [::setops::create [twapi::find_windows]]
        set caps   [::setops::create [twapi::find_windows -caption true]]
        set nocaps [::setops::create [twapi::find_windows -caption false]]
        set union  [::setops::union [list $caps $nocaps]]
        set inter  [::setops::Intersect $caps $nocaps]
        expr {[::setops::empty $inter] &&
              [::setops::empty [::setops::diff $all $union]] &&
              [::setops::empty [::setops::diff $union $all]]}
    } -result 0

    ################################################################

    test find_windows-4.1 {
        Find windows with a caption
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
    } -body {
        llength [twapi::find_windows -pids [list $np_pid] -caption true]
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test find_windows-4.2 {
        Find windows without caption
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
    } -body {
        expr {[llength [twapi::find_windows -pids [list $np_pid] -caption false]] > 0}
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test find_windows-5.0 {
        Verify -child true and -child false are exclusive and encompassing
    } -constraints {
        nt
    } -body {
        set all    [::setops::create [twapi::find_windows]]
        set caps   [::setops::create [twapi::find_windows -child true]]
        set nocaps [::setops::create [twapi::find_windows -child false]]
        set union  [::setops::union [list $caps $nocaps]]
        set inter  [::setops::Intersect $caps $nocaps]
        expr {[::setops::empty $inter] &&
              [::setops::empty [::setops::diff $all $union]] &&
              [::setops::empty [::setops::diff $union $all]]}
    } -result 0

    ################################################################

    test find_windows-5.1 {
        Verify find_windows returns non-child windows if -child false specifed
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_top [notepad_top $np_pid]
    } -body {
        expr {
              [lsearch -exact [twapi::find_windows -child false -pids [list $np_pid]] $np_top] >= 0
          }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test find_windows-5.2 {
        Verify find_windows does not return non-child windows if -child true specifed
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_top [notepad_top $np_pid]
    } -body {
        expr {
              [lsearch -exact [twapi::find_windows -child true -pids [list $np_pid]] $np_top] < 0
          }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test find_windows-5.3 {
        Verify find_windows returns child windows if -child true specifed
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_top [notepad_top $np_pid]
        set np_child [lindex [twapi::find_windows -ancestor $np_top] 0]
    } -body {
        expr {
              [lsearch -exact [twapi::find_windows -child true -pids [list $np_pid]] $np_child] >= 0
          }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test find_windows-5.4 {
        Verify find_windows does not return child windows if -child false specifed
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_top [notepad_top $np_pid]
        set np_child [lindex [twapi::find_windows -ancestor $np_top] 0]
    } -body {
        expr {
              [lsearch -exact [twapi::find_windows -child false -pids [list $np_pid]] $np_child] < 0
          }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test find_windows-6.0 {
        Verify find_windows returns windows of a specific class
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
    } -body {
        expr { [llength [twapi::find_windows -class Notepad]] > 0 }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test find_windows-6.1 {
        Verify find_windows returns windows of a specific class
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
    } -body {
        llength [twapi::find_windows -class NOSUCHCLASS]
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 0

    ################################################################

    test find_windows-7.0 {
        Verify find_windows returns windows with a specific title
    } -constraints {
        nt
    } -setup {
        set cur_np [llength [twapi::find_windows -text "Untitled - Notepad"]]
        set np_pid [notepad_exec]
    } -body {
        expr { [llength [twapi::find_windows -text "Untitled - Notepad"]] - $cur_np }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test find_windows-7.1 {
        Verify find_windows returns empty when searching for non-existent windows with a specific title
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
    } -body {
        # Note we use "*" - should not be treated as wildcard
        llength [twapi::find_windows -text "Untitled*"]
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 0

    ################################################################

    test find_windows-7.2 {
        Verify find_windows returns windows with a specific title using string matching
    } -constraints {
        nt
    } -setup {
        set cur_np [llength [twapi::find_windows -match string -text "UNTITLED - NOTEPAD"]]
        set np_pid [notepad_exec]
    } -body {
        # Note case should be ignored
        expr { [llength [twapi::find_windows -text "UNTITLED - NOTEPAD"]] - $cur_np }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test find_windows-7.3 {
        Verify find_windows returns does not match windows titles using wildcards when -string matching used
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
    } -body {
        # Note case should be ignored
        llength [twapi::find_windows -match string -text "UNTITLED*"]
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 0

    ################################################################

    test find_windows-7.4 {
        Verify find_windows matches windows titles using trailing wildcards
    } -constraints {
        nt
    } -setup {
        set cur_np [llength [twapi::find_windows -text "Untitled - Notepad"]]
        set np_pid [notepad_exec]
    } -body {
        # Note case should be ignored
        expr { [llength [twapi::find_windows -match glob -text "Untitled*"]] - $cur_np }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test find_windows-7.5 {
        Verify find_windows matches windows titles using leading wildcards
    } -constraints {
        nt
    } -setup {
        set cur_np [llength [twapi::find_windows -text "Untitled - Notepad"]]
        set np_pid [notepad_exec]
    } -body {
        # Note case should be ignored
        expr { [llength [twapi::find_windows -match glob -text "*Notepad"]] - $cur_np }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test find_windows-7.6 {
        Verify find_windows matches windows titles using middle wildcards
    } -constraints {
        nt
    } -setup {
        set cur_np [llength [twapi::find_windows -text "Untitled - Notepad"]]
        set np_pid [notepad_exec]
    } -body {
        # Note case should be ignored
        expr { [llength [twapi::find_windows -match glob -text "Un*No*ad"]] - $cur_np }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test find_windows-7.7 {
        Verify find_windows matches windows titles using regexp
    } -constraints {
        nt
    } -setup {
        set cur_np [llength [twapi::find_windows -text "Untitled - Notepad"]]
        set np_pid [notepad_exec]
    } -body {
        # Note case should be ignored
        expr { [llength [twapi::find_windows -match regexp -text {U.*n.*p[a|e]d}]] - $cur_np }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test find_windows-7.8 {
        Verify find_windows raises error on unknown match type
    } -constraints {
        nt
    } -setup {
    } -body {
        # Note case should be ignored
        twapi::find_windows -match foo -text WHOCARES
    } -cleanup {
    } -returnCodes {error} -result "Invalid value 'foo' specified for option '-match'. Must be one of string, glob, regexp"


    ################################################################

    test find_windows-8.0 {
        Find windows that are maximized
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
        twapi::maximize_window $np_win -sync
    } -body {
        # Note case should be ignored
        set wins [twapi::find_windows -class Notepad -pids [list $np_pid] -maximize 1]
        expr {
              [llength $wins] == 1 &&
              [lindex $wins 0] == $np_win
          }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test find_windows-8.1 {
        Verify windows that are maximized are not found when -maximize is false
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
        twapi::maximize_window $np_win -sync
    } -body {
        # Note case should be ignored
        twapi::find_windows -class Notepad -pids [list $np_pid] -maximize false
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result ""

    ################################################################

    test find_windows-9.0 {
        Find windows that are minimized
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
        twapi::minimize_window $np_win -sync
    } -body {
        # Note case should be ignored
        set wins [twapi::find_windows -class Notepad -pids [list $np_pid] -minimize true]
        expr {
              [llength $wins] == 1 &&
              [lindex $wins 0] == $np_win
          }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test find_windows-9.1 {
        Verify windows that are minimized are not found when -minimize is false
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
        twapi::minimize_window $np_win -sync
    } -body {
        # Note case should be ignored
        twapi::find_windows -class Notepad -pids [list $np_pid] -minimize 0
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result ""

    ################################################################


    test find_windows-10.0 {
        Find exactly those windows that have a maximize box (-maximizebox true)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec nosuchfile.txt]
        set np_win [notepad_top $np_pid]
    } -body {
        set wins [twapi::find_windows -match glob -text *Notepad -pids [list $np_pid] -maximizebox 1]
        # Popup dialog has no maximize button so we should find exactly one
        # window
        expr {
              [llength $wins] == 1 &&
              [lindex $wins 0] == $np_win
          }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test find_windows-10.1 {
        Find exactly those windows that do not have a maximize box (-maximizebox false)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec nosuchfile.txt]
        set popup_win [notepad_popup $np_pid]
    } -body {
        # Popup dialog has no maximize button so we should find exactly one
        # window (the popup0
        set wins [twapi::find_windows -match glob -text *Notepad -pids [list $np_pid] -maximizebox false]
        expr {
              [llength $wins] == 1 &&
              [lindex $wins 0] == $popup_win
          }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test find_windows-11.0 {
        Find exactly those windows that have a minimize box (-minimizebox true)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec nosuchfile.txt]
        set np_win [notepad_top $np_pid]
    } -body {
        set wins [twapi::find_windows -match glob -text *Notepad -pids [list $np_pid] -minimizebox 1]
        # Popup dialog has no minimize button so we should find exactly one
        # window
        expr {
              [llength $wins] == 1 &&
              [lindex $wins 0] == $np_win
          }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test find_windows-11.1 {
        Find exactly those windows that do not have a minimize box (-minimizebox false)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec nosuchfile.txt]
        set popup_win [notepad_popup $np_pid]
    } -body {
        # Popup dialog has no minimize button so we should find exactly one
        # window (the popup0
        set wins [twapi::find_windows -match glob -text *Notepad -pids [list $np_pid] -minimizebox false]
        expr {
              [llength $wins] == 1 &&
              [lindex $wins 0] == $popup_win
          }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test find_windows-12.0 {
        Find exactly those windows that are not popups (-popup false)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec nosuchfile.txt]
        set np_win [notepad_top $np_pid]
    } -body {
        set wins [twapi::find_windows -match glob -text *Notepad -pids [list $np_pid] -popup false]
        expr {
              [llength $wins] == 1 &&
              [lindex $wins 0] == $np_win
          }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test find_windows-12.1 {
        Find exactly those windows that are popups (-popup true)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec nosuchfile.txt]
        set popup_win [notepad_popup $np_pid]
    } -body {
        # Popup dialog has no maximize button so we should find exactly one
        # window (the popup0
        set wins [twapi::find_windows -match glob -text *Notepad -pids [list $np_pid] -popup true]
        expr {
              [llength $wins] == 1 &&
              [lindex $wins 0] == $popup_win
          }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test find_windows-13.0 {
        Find exactly those windows that are overlapped windows (-overlapped true)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec nosuchfile.txt]
        set np_win [notepad_top $np_pid]
    } -body {
        set wins [twapi::find_windows -match glob -text *Notepad -pids [list $np_pid] -overlapped true]
        expr {
              [llength $wins] == 1 &&
              [lindex $wins 0] == $np_win
          }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test find_windows-13.1 {
        Find exactly those windows that are not overlapped (-overlapped false)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec nosuchfile.txt]
        set np_win [notepad_top $np_pid]
        set popup_win [notepad_popup $np_pid]
    } -body {
        # Popup dialog has no maximize button so we should find exactly one
        # window (the popup0
        set wins [twapi::find_windows -match glob -text *Notepad -pids [list $np_pid] -overlapped false]
        expr {
              [lsearch -exact $wins $np_win] < 0 &&
              [lsearch -exact $wins $popup_win] >= 0
          }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test find_windows-14.0 {
        Find those windows that have a specific style
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec nosuchfile.txt]
        set np_win [notepad_top $np_pid]
    } -body {
        set wins [twapi::find_windows -pids [list $np_pid]  -style {0x1ccf0000 0x110}]
        expr {
              [llength $wins] == 1 &&
              [lindex $wins 0] == $np_win
          }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test find_windows-14.1 {
        Verify a window is not found if style does not match
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec nosuchfile.txt]
        set np_win [notepad_top $np_pid]
    } -body {
        # Note style is mismatched
        set wins [twapi::find_windows -pids [list $np_pid]  -style {0x14cf0000 0x110}]
        llength $wins
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 0

    ################################################################

    test find_windows-14.2 {
        Verify a window is not found if extended style does not match
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec nosuchfile.txt]
        set np_win [notepad_top $np_pid]
        set popup_win [notepad_popup $np_pid]
    } -body {
        # Note extended style is mismatched
        set wins [twapi::find_windows -pids [list $np_pid]  -style {0x1ccf0000 0x100}]
        llength $wins
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 0

    ################################################################

    test find_windows-15.0 {
        Verify -toplevel true and -toplevel false are exclusive and encompassing
    } -constraints {
        nt
    } -body {
        set all    [::setops::create [twapi::find_windows]]
        set caps   [::setops::create [twapi::find_windows -toplevel true]]
        set nocaps [::setops::create [twapi::find_windows -toplevel false]]
        set union  [::setops::union [list $caps $nocaps]]
        set inter  [::setops::Intersect $caps $nocaps]
        expr {[::setops::empty $inter] &&
              [::setops::empty [::setops::diff $all $union]] &&
              [::setops::empty [::setops::diff $union $all]]}
    } -result 0

    ################################################################

    test find_windows-15.1 {
        Find exactly those windows that are toplevel (-toplevel true)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec nosuchfile.txt]
        set np_win [notepad_top $np_pid]
        set popup_win [notepad_popup $np_pid]
    } -body {
        set wins [twapi::find_windows -pids [list $np_pid] -toplevel true]
        expr {
              [lsearch -exact $wins $np_win] >= 0 &&
              [lsearch -exact $wins $popup_win] >= 0
          }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test find_windows-15.2 {
        Find exactly those windows that are not toplevel (-toplevel 0)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec nosuchfile.txt]
        set np_win [notepad_top $np_pid]
        set popup_win [notepad_popup $np_pid]
    } -body {
        set wins [twapi::find_windows -pids [list $np_pid] -toplevel false]
        expr {
              [lsearch -exact $wins $np_win] < 0 &&
              [lsearch -exact $wins $popup_win] < 0
          }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test find_windows-16.0 {
        Verify -visible true and -visible false are exclusive and encompassing
    } -constraints {
        nt
    } -body {
        set all    [::setops::create [twapi::find_windows]]
        set caps   [::setops::create [twapi::find_windows -visible true]]
        set nocaps [::setops::create [twapi::find_windows -visible false]]
        set union  [::setops::union [list $caps $nocaps]]
        set inter  [::setops::Intersect $caps $nocaps]
        expr {[::setops::empty $inter] &&
              [::setops::empty [::setops::diff $all $union]] &&
              [::setops::empty [::setops::diff $union $all]]}
    } -result 0

    ################################################################

    test find_windows-16.1 {
        Find exactly those windows that are visible (-visible true)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec nosuchfile.txt]
        set np_win [notepad_top $np_pid]
        set popup_win [notepad_popup $np_pid]
    } -body {
        set wins [twapi::find_windows -pids [list $np_pid] -visible true]
        expr {
              [lsearch -exact  $wins $np_win] >= 0 &&
              [lsearch -exact  $wins $popup_win] >= 0
          }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test find_windows-16.2 {
        Find exactly those windows that are not visible (-visible 0)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec nosuchfile.txt]
        set np_win [notepad_top $np_pid]
        set popup_win [notepad_popup $np_pid]
    } -body {
        set wins [twapi::find_windows -pids [list $np_pid] -visible false]
        expr {
              [lsearch -exact  $wins $np_win] < 0 &&
              [lsearch -exact  $wins $popup_win] < 0
          }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1



    ################################################################

    test find_windows-17.0 {
        Verify -messageonlywindow true and false are exclusive and encompassing
    } -constraints {
        nt
    } -body {
        set all    [::setops::create [twapi::find_windows]]
        set caps   [::setops::create [twapi::find_windows -messageonlywindow true]]
        set nocaps [::setops::create [twapi::find_windows -messageonlywindow false]]
        set union  [::setops::union [list $caps $nocaps]]
        set inter  [::setops::Intersect $caps $nocaps]
        expr {[::setops::empty $inter] &&
              [::setops::empty [::setops::diff $all $union]] &&
              [::setops::empty [::setops::diff $union $all]]}
    } -result 0

    test find_windows-17.1 {
        Verify -messageonlywindow true and -text cannot be used together
    } -constraints {
        nt
    } -body {
        twapi::find_windows -messageonlywindow true -text "something"
    } -result "Option -text cannot be specified*-messageonly*true*" -match glob -returnCodes error

    ################################################################

    test get_descendent_windows-1.0 {
        Get descendent windows
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
        set edit_win [twapi::find_windows -class Edit -pids [list $np_pid] -single]
    } -body {
        set wins [twapi::get_descendent_windows [twapi::get_desktop_window]]
        # Both the toplevel and edit windows should be included
        expr {
              [lsearch -exact  $wins $np_win] >= 0 &&
              [lsearch -exact  $wins $edit_win] >=  0
          }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test get_parent_window-1.0 {
        Get parent windows
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
        set edit_win [twapi::find_windows -class Edit -pids [list $np_pid] -single]
    } -body {
        set win [twapi::get_parent_window $edit_win]
        expr {$win == $np_win}
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test get_owner_window-1.0 {
        Get the owner window of a toplevel window
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec nosuchfile.txt]
        set np_win [notepad_top $np_pid]
        set popup_win [notepad_popup $np_pid]
    } -body {
        twapi::get_owner_window $np_win
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result ""

    ################################################################

    test get_owner_window-1.1 {
        Get the owner window of a popup window
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec nosuchfile.txt]
        set np_win [notepad_top $np_pid]
        set popup_win [notepad_popup $np_pid]
    } -body {
        set win [twapi::get_owner_window $popup_win]
        expr {$win == $np_win}
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test get_child_windows-1.0 {
        Get child windows
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
        set edit_win [twapi::find_windows -class Edit -pids [list $np_pid]]
    } -body {
        set wins [twapi::get_child_windows [twapi::get_desktop_window]]
        # The edit window should not be included as it is not a direct child
        expr {
              [lsearch -exact  $wins $np_win] >= 0 &&
              [lsearch -exact  $wins $edit_win] < 0
          }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test get_first_child-1.0 {
        Get first child window
    } -constraints {
        nt
    } -body {
        set win [twapi::get_first_child [twapi::get_desktop_window]]
        twapi::get_prev_sibling_window $win
    } -result ""

    ################################################################

    test get_next_sibling_window-1.0 {
        Get next sibling window
    } -constraints {
        nt
    } -setup {
        set dt_win [twapi::get_desktop_window]
        set first_child [twapi::get_first_child $dt_win]
    } -body {
        set win [twapi::get_next_sibling_window $first_child]
        expr {$dt_win == [twapi::get_parent_window $win]}
    } -result 1

    ################################################################

    test get_prev_sibling_window-1.0 {
        Get previous sibling window for first child
    } -constraints {
        nt
    } -setup {
        set dt_win [twapi::get_desktop_window]
        set first_child [twapi::get_first_child $dt_win]
    } -body {
        twapi::get_prev_sibling_window $first_child
    } -result ""

    ################################################################

    test get_prev_sibling_window-1.1 {
        Get prev sibling window
    } -constraints {
        nt
    } -setup {
        set dt_win [twapi::get_desktop_window]
        set first [twapi::get_first_child $dt_win]
        set second [twapi::get_next_sibling_window $first]
    } -body {
        expr { $first == [twapi::get_prev_sibling_window $second] }
    } -result 1

    ################################################################

    test get_first_sibling_window-1.0 {
        Get first sibling window
    } -constraints {
        nt
    } -setup {
        set dt_win [twapi::get_desktop_window]
        set first [twapi::get_first_child $dt_win]
        set second [twapi::get_next_sibling_window $first]
    } -body {
        expr { $first == [twapi::get_first_sibling_window $second] }
    } -result 1

    ################################################################

    test get_last_sibling_window-1.0 {
        Get last sibling window
    } -constraints {
        nt
    } -setup {
        set dt_win [twapi::get_desktop_window]
        set first [twapi::get_first_child $dt_win]
    } -body {
        set last [twapi::get_last_sibling_window $first]
        expr {
              [twapi::get_next_sibling_window $last] == "" &&
              [twapi::get_parent_window $last] == $dt_win
          }
    } -result 1

    ################################################################

    test get_desktop_window-1.0 {
        Get desktop window
    } -constraints {
        nt
    } -setup {
        set win [twapi::find_windows -toplevel 1 -single]
    } -body {
        expr {
              [twapi::get_parent_window $win] == [twapi::get_desktop_window]
          }
    } -cleanup {
    } -result 1

    ################################################################

    test get_shell_window-1.0 {
        Get shell window
    } -constraints {
        nt
    } -body {
        # Don't really know how to verify it is a shell window other than
        # class ?
        twapi::get_window_class [twapi::get_shell_window]
    } -result Progman

    ################################################################

    test get_window_process-1.0 {
        Get the process for a window
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        expr {$np_pid == [twapi::get_window_process $np_win]}
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test get_window_thread-1.0 {
        Get the process for a window
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        expr {$np_pid == [twapi::get_thread_parent_process_id [twapi::get_window_thread $np_win]]}
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test get_window_style-1.0 {
        Get the window style
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        set styles [twapi::get_window_style $np_win]
        expr {
              [string is integer [lindex $styles 0]] &&
              [string is integer [lindex $styles 1]] &&
              [lsearch -exact $styles minimizebox] >= 0 &&
              [lsearch -exact $styles maximizebox] >= 0 &&
              [lsearch -exact $styles overlapped] >= 0 &&
              [lsearch -exact $styles caption] >= 0 &&
              [lsearch -exact $styles visible] >= 0 &&
              [lsearch -exact $styles clipsiblings] >= 0 &&
              [lsearch -exact $styles sysmenu] >= 0
          }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test set_window_style-1.0 {
        Set the window style
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
        foreach {oldstyle oldexstyle} [twapi::get_window_style $np_win] break
    } -body {
        # Turn off sysmenu
        set newstyle [expr {$oldstyle & ~ 0x80000}]
        # Accept files
        set newexstyle [expr {$oldexstyle | 0x01}]
        twapi::set_window_style $np_win $newstyle $newexstyle
        foreach {newstylecheck newexstylecheck} [twapi::get_window_style $np_win] break
        expr {
              $newstyle == $newstylecheck &&
              $newexstyle == $newexstylecheck
          }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test get_window_class-1.0 {
        Get the window class
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        twapi::get_window_class $np_win
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result Notepad

    ################################################################

    test get_window_real_class-1.0 {
        Get the window class
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        twapi::get_window_class $np_win
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result Notepad

    ################################################################

    test get_window_long-1.0 {
        Get a window longword
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        set longval [twapi::get_window_long $np_win -16]
        expr {$longval == [lindex [twapi::get_window_style $np_win] 0]}
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test set_window_long-1.0 {
        Set a window longword
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
        foreach {oldstyle oldexstyle} [twapi::get_window_style $np_win] break
    } -body {
        # Turn off sysmenu
        set newstyle [expr {$oldstyle & ~ 0x80000}]
        twapi::set_window_long $np_win -16 $newstyle
        foreach {newstylecheck newexstylecheck} [twapi::get_window_style $np_win] break
        expr {
              $newstyle == $newstylecheck &&
              $oldexstyle == $newexstylecheck
          }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test get_window_application-1.0 {
        Get the window application
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        string is integer [twapi::get_window_application $np_win]
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test get_window_id-1.0 {
        Get the window id
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        string is integer [twapi::get_window_id $np_win]
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test get_window_userdata-1.0 {
        Get the window user data
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        # Assumes notepad userdata is always 0
        twapi::get_window_userdata $np_win
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 0

    ################################################################

    test set_window_userdata-1.0 {
        Get the window user data
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        # Assumes notepad userdata is always 0
        set old_data [twapi::get_window_userdata $np_win]
        set orig_data [twapi::set_window_userdata $np_win 1]
        set new_data [twapi::get_window_userdata $np_win]
        expr {
              $old_data == $orig_data &&
              $new_data == 1
          }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test get_foreground_window-1.0 {
        Get the foreground window
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        expr {[twapi::get_foreground_window] == $np_win}
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test set_foreground_window-1.0 {
        Set the foreground window
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
        set np_pid2 [notepad_exec]
        set np_win2 [notepad_top $np_pid2]
    } -body {
        expr {
              [twapi::get_foreground_window] == $np_win2 &&
              [twapi::set_foreground_window $np_win] &&
              [twapi::get_foreground_window] == $np_win
          }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
        twapi::end_process $np_pid2 -wait $end_process_timeout
    } -result 1

    ################################################################

    test set_active_window_for_thread-1.0 {
    } -constraints {
        nt TBD
    } -setup {
    } -body {
    } -cleanup {
    } -result TBD

    ################################################################

    test get_active_window_for_thread-1.0 {
        Get the active window for a thread
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_tid [lindex [lindex [twapi::get_process_info $np_pid -tids] 1] 0]
    } -body {
        expr {
              [twapi::get_active_window_for_thread $np_tid] eq [notepad_top $np_pid]
          }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test get_focus_window_for_thread-1.0 {
        Get the active window for a thread
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_tid [lindex [lindex [twapi::get_process_info $np_pid -tids] 1] 0]
    } -body {
        expr {
              [twapi::get_parent_window [twapi::get_focus_window_for_thread $np_tid]] eq [notepad_top $np_pid]
          }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test get_active_window_for_current_thread-1.0 {
    } -constraints {
        nt TBD
    } -setup {
    } -body {
    } -cleanup {
    } -result TBD

    ################################################################

    test redraw_window_frame-1.0 {
        Redraw a window frame
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        twapi::redraw_window_frame $np_win
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result ""

    ################################################################

    test redraw_window-1.0 {
        Redraw a window
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        twapi::redraw_window $np_win
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result ""

    ################################################################

    test move_window-1.0 {
        Move a window asynchronously
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        twapi::move_window $np_win 20 30
        after 100;                      # Give it time to finish
        foreach {left top right bottom} [twapi::get_window_coordinates $np_win] break
        expr { $left == 20 && $top == 30 }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ###

    test move_window-1.1 {
        Move a window synchronously
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        twapi::move_window $np_win 20 30 -sync
        foreach {left top right bottom} [twapi::get_window_coordinates $np_win] break
        expr { $left == 20 && $top == 30 }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test resize_window-1.0 {
        Resize a window
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        twapi::resize_window $np_win 400 600
        after 100;                      # Give it time to finish
        foreach {left top right bottom} [twapi::get_window_coordinates $np_win] break
        expr { ($right-$left) == 400 && ($bottom-$top) == 600 }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ###

    test resize_window-1.1 {
        Resize a window synchronously
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        twapi::resize_window $np_win 400 600 -sync
        foreach {left top right bottom} [twapi::get_window_coordinates $np_win] break
        expr { ($right-$left) == 400 && ($bottom-$top) == 600 }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test set_window_zorder-1.0 {
        Set window zorder right after another
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
        set np_pid2 [notepad_exec]
        set np_win2 [notepad_top $np_pid2]
    } -body {
        twapi::set_window_zorder $np_win2 $np_win
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
        twapi::end_process $np_pid2 -wait $end_process_timeout
    } -result ""

    ################################################################

    test set_window_zorder-2.0 {
        Set window zorder to the top
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        twapi::set_window_zorder $np_win top
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result ""

    ################################################################

    test set_window_zorder-3.0 {
        Set window zorder to the bottom
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        twapi::set_window_zorder $np_win bottom
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result ""

    ################################################################

    test set_window_zorder-4.0 {
        Set window zorder to the top most
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        twapi::set_window_zorder $np_win toplayer
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result ""

    ################################################################

    test set_window_zorder-5.0 {
        Set window zorder to the bottom most
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        twapi::set_window_zorder $np_win bottomlayer
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result "" 

    ################################################################

    test show_window-1.0 {
        Show a window
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        twapi::show_window $np_win
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test show_window-2.0 {
        Show a window and activate it (-activate)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        # TBD - how to verify it was actually activated?
        twapi::show_window $np_win -activate
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test show_window-3.0 {
        Show a window restoring it from minimized (-normal)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
        twapi::minimize_window $np_win -sync
    } -body {
        twapi::show_window $np_win -normal
        after 50;                       # Give it a chance to take effect
        twapi::window_minimized $np_win
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 0

    ################################################################

    test show_window-4.0 {
        Show a window synchrously (-normal -sync)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
        twapi::maximize_window $np_win -sync
    } -body {
        twapi::show_window $np_win -normal -sync
        # Note we -sync means we don't need to wait
        twapi::window_maximized $np_win
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 0

    ################################################################

    test show_window-5.0 {
        Show a window in startup coords (-startup)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
        twapi::maximize_window $np_win -sync
    } -body {
        twapi::show_window $np_win -startup
        after 50;                       # Give it a chance to take effect
        twapi::window_maximized $np_win
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 0

    ################################################################

    test hide_window-1.0 {
        Hide a window asynchronously
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        twapi::hide_window $np_win
        after 50;                       # Wait for it to take effect
        twapi::window_visible $np_win
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 0

    ################################################################

    test hide_window-2.0 {
        Hide a window synchronously (-sync)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        twapi::hide_window $np_win  -sync
        # Note we -sync means we don't need to wait
        twapi::window_visible $np_win
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 0

    ################################################################

    test restore_window-1.0 {
        Restore a window
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
        twapi::minimize_window $np_win -sync
    } -body {
        twapi::restore_window $np_win
        twapi::window_minimized $np_win
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 0

    ################################################################

    test restore_window-2.0 {
        Restore a window using -sync option
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
        twapi::minimize_window $np_win -sync
    } -body {
        twapi::restore_window $np_win -sync
        twapi::window_minimized $np_win
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 0

    ################################################################

    test restore_window-3.0 {
        Restore a window using -activate option
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
        twapi::minimize_window $np_win -sync
    } -body {
        twapi::restore_window $np_win -activate -sync
        twapi::window_minimized $np_win
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 0

    ################################################################

    test maximize_window-1.0 {
        Maximize a window
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        set was_visible [twapi::maximize_window $np_win]
        after 50;                       # Give it a chance to take effect
        expr {$was_visible && [twapi::window_maximized $np_win]}
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test maximize_window-2.0 {
        Maximize a window synchronously
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
        twapi::hide_window $np_win -sync
    } -body {
        set was_visible [twapi::maximize_window $np_win -sync]
        expr {$was_visible == 0 && [twapi::window_maximized $np_win]}
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test minimize_window-1.0 {
        Minimize a window
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        set was_visible [twapi::minimize_window $np_win]
        after 50;                       # Give it a chance to take effect
        expr {$was_visible && [twapi::window_minimized $np_win]}
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test minimize_window-2.0 {
        Minimize a window synchronously
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
        twapi::hide_window $np_win -sync
    } -body {
        set was_visible [twapi::minimize_window $np_win -sync]
        expr {$was_visible == 0 && [twapi::window_minimized $np_win]}
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test minimize_window-3.0 {
        Minimize a window synchronously with -activate
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        set was_visible [twapi::minimize_window $np_win -sync -activate]
        expr {$was_visible && [twapi::window_minimized $np_win]}
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test minimize_window-4.0 {
        Minimize a window synchronously with -shownext
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        set was_visible [twapi::minimize_window $np_win -sync -shownext]
        expr {$was_visible && [twapi::window_minimized $np_win]}
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test hide_owned_popups-1.0 {
        Hide owned popups for a window
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec nosuchfile.txt]
        set np_win [notepad_top $np_pid]
        set popup_win [notepad_popup $np_pid]
    } -body {
        expr {
              [twapi::hide_owned_popups $np_win] == "" &&
              ! [twapi::window_visible $popup_win]
          }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test show_owned_popups-1.0 {
        Show owned popups for a window
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec nosuchfile.txt]
        set np_win [notepad_top $np_pid]
        set popup_win [notepad_popup $np_pid]
    } -body {
        expr {
              [twapi::hide_owned_popups $np_win] == "" &&
              ! [twapi::window_visible $popup_win] &&
              [twapi::show_owned_popups $np_win] == "" &&
              [twapi::window_visible $popup_win]
          }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test enable_window_input-1.0 {
        Enable input for a window
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        # TBD - how do we test this
        twapi::enable_window_input $np_win
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 0

    ################################################################

    test disable_window_input-1.0 {
        Disable input for a window
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        # TBD - how do we test this
        twapi::disable_window_input $np_win
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 0

    test close_window-1.0 {
        Close a window
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        twapi::close_window $np_win
        after 50;                       # Give it a chance
        twapi::process_exists $np_pid
    } -result 0

    test close_window-2.0 {
        Close a window asynchronously (-wait 0)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        twapi::close_window $np_win -wait 0
        after 50
        twapi::process_exists $np_pid
    } -result 0

    test close_window-3.0 {
        Close a window synchronously (-wait)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        twapi::close_window $np_win  -wait 500
        twapi::process_exists $np_pid
    } -result 0

    test close_window-4.0 {
        Close an Explorer window
    } -constraints {
        nt
    } -setup {
        twapi::shell_execute;   # Shows current folder
        set win [wait_for_window -text [file tail [pwd]]* -match glob -pids [list [get_explorer_pid]]]
    } -body {
        # This test specifically tests Explorer window because
        # the old 2.2 method of SendMessage did not work for Explorer
        twapi::close_window $win  -wait 500
        twapi::window_exists $win
    } -result 0

    ################################################################

    test window_minimized-1.0 {
        Check if window minimized (false)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        twapi::window_minimized $np_win
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 0

    ################################################################

    test window_minimized-1.1 {
        Check if window minimized (true)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
        twapi::minimize_window $np_win -sync
    } -body {
        twapi::window_minimized $np_win
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test window_maximized-1.0 {
        Check if window maximized (false)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        twapi::window_maximized $np_win
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 0

    ################################################################

    test window_maximized-1.1 {
        Check if window maximized (true)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
        twapi::maximize_window $np_win -sync
    } -body {
        twapi::window_maximized $np_win
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test window_visible-1.0 {
        Check if a window is visible (false)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        twapi::hide_window $np_win  -sync
        # Note we -sync means we don't need to wait
        twapi::window_visible $np_win
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 0

    ################################################################

    test window_visible-1.1 {
        Check if a window is visible (true)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        twapi::window_visible $np_win
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test window_exists-1.0 {
        Check if a window exists (false)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
        twapi::end_process $np_pid -wait $end_process_timeout
    } -body {
        twapi::window_exists $np_win
    } -cleanup {
    } -result 0

    ################################################################

    test window_exists-1.1 {
        Check if a window exists (true)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        twapi::window_exists $np_win
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test window_unicode_enabled-1.0 {
        Check if a window accpets Unicode input
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        twapi::window_unicode_enabled $np_win
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test window_input_enabled-1.0 {
        Check if a window is enabled (true)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        twapi::window_input_enabled $np_win
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test window_input_enabled-1.1 {
        Check if a window is enabled (false)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
        twapi::disable_window_input $np_win
    } -body {
        twapi::window_input_enabled $np_win
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 0

    ################################################################

    test window_is_child-1.0 {
        Check if a window is a child of another (true)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
        set edit_win [twapi::find_windows -class Edit -pids [list $np_pid] -single]
    } -body {
        twapi::window_is_child $np_win $edit_win
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test window_is_child-1.1 {
        Check if a window is a child of another (false)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec nosuchfile.txt]
        set np_win [notepad_top $np_pid]
        set popup_win [notepad_popup $np_pid]
    } -body {
        twapi::window_is_child $np_win $popup_win
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 0

    ################################################################

    test set_focus-1.0 {
        Set focus to a window
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
        set edit_win [twapi::find_windows -class Edit -pids [list $np_pid] -single]
    } -body {
        # TBD - need a better test to test that it does have focus
        expr {[twapi::set_focus $np_win] == $edit_win}
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test flash_window_caption-1.0 {
        Flash a window caption
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        string is integer [twapi::flash_window_caption $np_win]
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test flash_window_caption-1.1 {
        Flash a window caption (-toggle)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        string is integer [twapi::flash_window_caption $np_win -toggle]
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test flash_window-1.0 {
        Flash a window
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        string is integer -strict [twapi::flash_window $np_win]
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ###

    test flash_window-2.0 {
        Flash a window a specific number of times
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        string is integer -strict [twapi::flash_window $np_win -count 5]
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ###

    test flash_window-3.0 {
        Flash a window caption without flashing the taskbar
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        string is integer -strict [twapi::flash_window $np_win -notaskbar]
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ###

    test flash_window-4.0 {
        Flash a window taskbar icon without flashing the caption
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        string is integer -strict [twapi::flash_window $np_win -nocaption]
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ###

    test flash_window-5.0 {
        Flash a window for a period of time
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        twapi::flash_window $np_win -start
        after 5000
        string is integer -strict [twapi::flash_window $np_win -stop]
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1


    ################################################################

    test beep-1.0 {
        Beep
    } -constraints {
        userInteraction
    } -body {
        twapi::beep
        yesno "Did you hear a beep?"
    } -result 1

    test beep-2.0 {
        Beep at non-default frequency
    } -constraints {
        userInteraction
    } -body {
        twapi::beep -frequency 3000
        yesno "Did you hear a higher pitch beep?"
    } -result 1

    test beep-3.0 {
        Beep for non-default duration
    } -constraints {
        userInteraction
    } -body {
        set duration [lindex [time {twapi::beep -duration 500}] 0]
        list [expr {$duration > 450000}] [yesno "Did you hear a long beep?"]
    } -result {1 1}

    test beep-4.0 {
        Beep -type ok
    } -constraints {
        userInteraction
    } -body {
        twapi::beep -type ok
        yesno "Did you hear a 'ok' beep?"
    } -result 1

    test beep-4.1 {
        Beep -type hand
    } -constraints {
        userInteraction
    } -body {
        twapi::beep -type hand
        yesno "Did you hear a 'hand' beep?"
    } -result 1

    test beep-4.2 {
        Beep -type question
    } -constraints {
        userInteraction
    } -body {
        twapi::beep -type question
        yesno "Did you hear a 'question' beep?"
    } -result 1

    test beep-4.3 {
        Beep -type exclaimation
    } -constraints {
        userInteraction
    } -body {
        twapi::beep -type exclaimation
        yesno "Did you hear a 'exclaimation' beep?"
    } -result 1

    test beep-4.4 {
        Beep -type
    } -constraints {
        userInteraction
    } -body {
        twapi::beep -type asterisk
        yesno "Did you hear a 'asterisk' beep?"
    } -result 1


    ################################################################

    test arrange_icons-1.0 {
        Arrange desktop icons
    } -constraints {
        nt systemmodificationok
    } -body {
        string is integer [twapi::arrange_icons]
    } -result 1

    ################################################################

    test arrange_icons-1.1 {
        Arrange icons for a window
    } -constraints {
        nt systemmodificationok
    } -body {
        string is integer [twapi::arrange_icons [twapi::get_desktop_window]]
    } -result 1


    ################################################################

    test get_window_text-1.0 {
        Get a window text
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        twapi::get_window_text $np_win
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result "Untitled - Notepad"

    ################################################################

    test set_window_text-1.0 {
        Set window text
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        twapi::set_window_text $np_win "New Title"
        twapi::get_window_text $np_win
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result "New Title"

    ################################################################

    test get_window_client_area_size-1.0 {
        Get size of a window's client area
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        foreach {w h} [twapi::get_window_client_area_size $np_win] break
        twapi::minimize_window $np_win -sync
        foreach {minw minh} [twapi::get_window_client_area_size $np_win] break
        expr {
              [string is integer $w] &&
              [string is integer $h] &&
              $minw == 0 &&
              $minh == 0
          }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test get_window_coordinates-1.0 {
        Get a window's coordinates
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        foreach {left top right bottom} [twapi::get_window_coordinates $np_win] break
        expr { $right > $left && $bottom > $top }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test get_window_at_location-1.0 {
        Get the window at a screen location
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
        twapi::set_window_zorder $np_win toplayer
    } -body {
        foreach {left top right bottom} [twapi::get_window_coordinates $np_win] break
        # ON XP, window edges are curved so add an increment
        incr left $button_edge_offset
        incr top $button_edge_offset
        set win [twapi::get_window_at_location $left $top]
        expr { $win == $np_win }
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result 1

    ################################################################

    test invalidate_screen_region-1.0 {
        Invalidate the screen
    } -constraints {
        nt
    } -body {
        # TBD - how to check results?
        twapi::invalidate_screen_region
    } -result ""

    ################################################################

    test invalidate_screen_region-1.1 {
        Invalidate the screen erasing the background
    } -constraints {
        nt
    } -body {
        # TBD - how to check results?
        twapi::invalidate_screen_region -bgerase
    } -result ""

    ################################################################

    test invalidate_screen_region-2.0 {
        Invalidate a region of the screen
    } -constraints {
        nt
    } -body {
        # TBD - how to check results?
        twapi::invalidate_screen_region -rect {50 50 200 200}
    } -result ""

    ################################################################

    test invalidate_screen_region-2.1 {
        Invalidate a region of the screen erasing the background
    } -constraints {
        nt
    } -body {
        # TBD - how to check results?
        twapi::invalidate_screen_region -rect {50 50 200 200} -bgerase
    } -result ""

    ################################################################

    test invalidate_screen_region-3.0 {
        Invalidate a window
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        # TBD - how to check results?
        twapi::invalidate_screen_region $np_win
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result ""

    ################################################################

    test invalidate_screen_region-3.1 {
        Invalidate a window erasing the background
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        # TBD - how to check results?
        twapi::invalidate_screen_region $np_win -bgerase
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result ""

    ################################################################

    test get_caret_blink_time-1.0 {
        Get the blink time of a caret
    } -constraints {
        nt
    } -body {
        string is integer [twapi::get_caret_blink_time]
    } -result 1

    ################################################################

    test set_caret_blink_time-1.0 {
        Set the blink time of a caret
    } -constraints {
        nt systemmodificationok
    } -setup {
        set old_blink [twapi::get_caret_blink_time]
    } -body {
        set new_blink [expr {$old_blink+1000}]
        twapi::set_caret_blink_time $new_blink
        expr {[twapi::get_caret_blink_time] == $new_blink}
    } -result 1

    ################################################################

    test invalidate_screen_region-2.1 {
        Invalidate a region of the screen erasing the background
    } -constraints {
        nt
    } -body {
        # TBD - how to check results?
        twapi::invalidate_screen_region -rect {50 50 200 200} -bgerase
    } -result ""

    ################################################################

    test hide_caret-1.0 {
        Hide the caret
    } -constraints {
        nt systemmodificationok TBD
    } -body {
        # TBD - returns access denied - probably needs to run in
        # a Win32 process, not a console shell
        twapi::hide_caret
    } -result ""

    ################################################################

    test show_caret-1.0 {
        Show the caret
    } -constraints {
        nt systemmodificationok TBD
    } -body {
        # TBD - returns access denied - probably needs to run in
        # a Win32 process, not a console shell
        twapi::show_caret
    } -result ""

    ################################################################

    test get_caret_location-1.0 {
        Get the caret location
    } -constraints {
        nt
    } -body {
        foreach {x y} [twapi::get_caret_location] break
        expr {[string is integer $x] && [string is integer $y]}
    } -result 1

    ################################################################

    test get_display_size-1.0 {
        Get the size of the display
    } -constraints {
        nt
    } -body {
        foreach {x y} [twapi::get_display_size] break
        expr { [string is integer $x] && [string is integer $y] }
    } -result 1

    ################################################################

    test send_input-1.0 {
        Send input to a window
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
        foreach {left top right bottom} [twapi::get_window_coordinates $np_win] break
        foreach {display_width display_height} [twapi::get_display_size] break
    } -body {
        # TBD - this does not test a lot of the modifiers

        # Enter abC
        set input {
            {key 65 0}
            {keydown 66 0}
            {keyup 66 0}
            {unicode 0 67}
        }

        # Right click the mouse in the body area. Note absolute coords
        # are on a scale of 0-65535 so need to scale based on
        # actual screen size
        set x [expr {(($left+200)*65535)/$display_width}]
        set y [expr {(($top+200)*65535)/$display_height}]

        lappend input \
            [list mouse $x $y -moved] \
            [list mouse 0 0 -rdown] \
            [list mouse 0 0 -rup]

        # Append an escape to get rid of the popup menu
        lappend input \
            [list keydown 0 1 -usescan] \
            [list keyup   0 1 -usescan]

        # Move mouse wheel for the heck of it
        lappend input [list mouse 0 0 -wheel 2]

        # Now send control characters to erase what we entered
        # Number has to be at least the same as characters entered above
        # else we will not be able to close the window below
        # Backspace is ascii 8 or scan code 14

        lappend input \
            [list key 8 0] \
            [list keydown 8 0] \
            [list keyup 8 0] \
            [list key 0 14 -usescan]

        # Now move the mouse to the X at top right and close the window
        set x [expr {(($right-$button_edge_offset)*65535)/$display_width}]
        set y [expr {(($top+$button_edge_offset)*65535)/$display_height}]
        lappend input \
            [list mouse $x $y -moved] \
            [list mouse 0 0 -ldown] \
            [list mouse 0 0 -lup]

        twapi::set_focus $np_win
        after 100
        twapi::send_input $input

        # Give it a chance to process events
        after 150;

        # Process should have exited
        twapi::process_exists $np_pid
    } -result 0


    ################################################################

    test block_input-1.0 {
        Block input
    } -constraints {
        nt userInteraction
    } -body {
        set np_pid [notepad_exec_and_insert "PLEASE TRY TYPING CHARACTERS INTO NOTEPAD (SHOULD FAIL). WILL EXIT AUTOMATICALLY AFTER 15 SECONDS."]
        twapi::block_input
        after 15000 "twapi::end_process $np_pid -force ; twapi::unblock_input; set ::wait_over 1"
        vwait ::wait_over
        yesno "Were characters blocked?"
    } -result 1

    ################################################################

    test unblock_input-1.0 {
        Unblock input
    } -constraints {
        nt userInteraction
    } -body {
        set np_pid [notepad_exec_and_insert "PLEASE TRY TYPING CHARACTERS INTO NOTEPAD. SHOULD INITIALLY FAIL, THEN SUCCEED AFTER A FEW SECONDS. WILL EXIT AUTOMATICALLY."]
        twapi::block_input
        after 7000 twapi::unblock_input
        after 12000 "twapi::end_process $np_pid -force ; set ::wait_over 1"
        vwait ::wait_over
        yesno "Were characters INITIALLY blocked, then UNBLOCKED?"
    } -result 1


    ################################################################

    test send_input_text-1.0 {
        Send input text to a window
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        # TBD - include a unicode character in this
        twapi::set_focus $np_win
        twapi::send_input_text "abc"
        # Copy to clipboard
        twapi::send_keys ^a^x
        # Wait for them to be processed
        after 50
        twapi::open_clipboard
        twapi::read_clipboard_text
    } -cleanup {
        twapi::close_clipboard
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result "abc"


    ################################################################

    test send_keys-1.0 {
        Send VB style keys to a window
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        # TBD - need to try more combinations

        # "aBCDDD", Ctrl-a to select, Alt-e c to copy, BACKSPACE to delete
        # ALT to bring up menu, RETURN to open file menu, x to exit
        set keys {a+(bc){D 3}^a%ec{BACKSPACE}{ALT}{RETURN}x}

        twapi::set_focus $np_win
        twapi::send_keys $keys

        # Give it a chance to process events
        after 50;

        twapi::open_clipboard
        set text [twapi::read_clipboard_text]

        # Process should have exited
        expr {
              [string equal $text "aBCDDD"] &&
              ![twapi::process_exists $np_pid]
          }
    } -cleanup {
        twapi::close_clipboard
    } -result 1


    ################################################################

    test register_hotkey-1.0 {
        Register a hot key using a ctrl seq
    } -constraints {
        nt userInteraction
    } -body {
        hotkey_test ctrl-d
    } -result success

    test register_hotkey-1.1 {
        Register a hot key using a ctrl-shift seq
    } -constraints {
        nt userInteraction
    } -body {
        hotkey_test ctrl-shift-h
    } -result success

    test register_hotkey-1.2 {
        Register a hot key using a ctrl-alt seq
    } -constraints {
        nt userInteraction
    } -body {
        hotkey_test ctrl-alt-s
    } -result success

    test register_hotkey-1.3 {
        Register a hot key using an alt seq
    } -constraints {
        nt userInteraction
    } -body {
        hotkey_test alt-f12
    } -result success

    test register_hotkey-1.5 {
        Register a hot key using a ctrl-alt virtual key code
    } -constraints {
        nt userInteraction
    } -body {
        puts "NOTE: Virtual code 65 is the letter 'a'"
        hotkey_test ctrl-alt-65
    } -result success


    ###

    test register_hotkey-2.0 {
        Register multiple scripts for a hot key without -append
    } -constraints {
        nt userInteraction
    } -body {
        set ::twapi_test_hotkey_result ""
        hotkey_test_append ctrl-alt-s ::twapi_test_hotkey_result "append ::twapi_test_hotkey_result script1" "append ::twapi_test_hotkey_result script2" noappend
        set ::twapi_test_hotkey_result
    } -result "script2"

    test register_hotkey-2.1 {
        Register multiple scripts for a hot key with -append
    } -constraints {
        nt userInteraction
    } -body {
        set ::twapi_test_hotkey_result ""
        hotkey_test_append ctrl-alt-s ::twapi_test_hotkey_result "append ::twapi_test_hotkey_result script1" "append ::twapi_test_hotkey_result script2" append
        set ::twapi_test_hotkey_result
    } -result "script1script2"

    test register_hotkey-2.2 {
        Register multiple scripts for a hot key with -append and break
    } -constraints {
        nt userInteraction
    } -body {
        set ::twapi_test_hotkey_result ""
        hotkey_test_append ctrl-alt-s ::twapi_test_hotkey_result "append ::twapi_test_hotkey_result script1 ; break" "append ::twapi_test_hotkey_result script2" append
        set ::twapi_test_hotkey_result
    } -result "script1"


    ################################################################

    test unregister_hotkey-1.0 {
        Unregister a hot key
    } -constraints {
        nt userInteraction
    } -body {
        # This registers and unregisters
        if {[hotkey_test ctrl-alt-s] ne "success"} {
            error "Did not succeed setting up hotkeys."
        }
        # Verify hotkey is not active any more
        set after_id [after 5000 "set ::twapi_test_hotkey_result timeout"]
        puts "Please press CTRL-ALT-S again within 5 seconds (to verify unregistration)"
        vwait ::twapi_test_hotkey_result
        after cancel $after_id
        # Result should be timeout
        set ::twapi_test_hotkey_result
    } -result timeout

    ################################################################

    test click_mouse_button-1.0 {
        Click left mouse button (left)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
        foreach {left top right bottom} [twapi::get_window_coordinates $np_win] break
    } -body {
        # Move the mouse to the X at top right and close the window
        incr top $button_edge_offset
        incr right -$button_edge_offset
        twapi::move_mouse $right $top
        twapi::click_mouse_button left

        # Give it a chance to process events
        after 50;

        # Process should have exited
        twapi::process_exists $np_pid
    } -result 0

    ################################################################

    test click_mouse_button-1.1 {
        Click left mouse button (1)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
        foreach {left top right bottom} [twapi::get_window_coordinates $np_win] break
    } -body {
        # Move the mouse to the X at top right and close the window
        incr top $button_edge_offset
        incr right -$button_edge_offset
        twapi::move_mouse $right $top
        twapi::click_mouse_button 1

        # Give it a chance to process events
        after 50;

        # Process should have exited
        twapi::process_exists $np_pid
    } -result 0

    ################################################################

    test click_mouse_button-1.2 {
        Click right mouse button (right)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
        foreach {left top right bottom} [twapi::get_window_coordinates $np_win] break
    } -body {
        # TBD Need some better test
        incr top 100
        incr left 100
        twapi::move_mouse $left $top
        twapi::click_mouse_button right
    } -cleanup {
        twapi::end_process $np_pid -wait $end_process_timeout
    } -result ""

    ################################################################

    test move_mouse-1.0 {
        Move the mouse (absolute)
    } -constraints {
        nt
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
        foreach {left top right bottom} [twapi::get_window_coordinates $np_win] break
    } -body {
        # Move the mouse to the X at top right and close the window
        incr top $button_edge_offset
        incr right -$button_edge_offset
        set result [twapi::move_mouse $right $top]
        twapi::click_mouse_button left

        # Give it a chance to process events
        after 50;

        expr {
              $result == "" &&
              ![twapi::process_exists $np_pid]
          }
    } -result 1

    ################################################################

    test move_mouse-2.0 {
        Move the mouse (relative)
    } -constraints {
        nt
    } -body {
        # TBD Need some better test than just syntax
        twapi::move_mouse 100 100 -relative
    } -result ""

    ################################################################

    test turn_mouse_wheel-1.0 {
        Turn the mouse wheel
    } -constraints {
        nt
    } -body {
        # TBD Need some better test than just syntax
        twapi::turn_mouse_wheel 2
    } -result ""

    ################################################################

    test get_mouse_location-1.0 {
        Get the mouse location
    } -constraints {
        nt
    } -body {
        # TBD Need some better test than just syntax
        foreach {x y} [twapi::get_mouse_location] break
        expr {[string is integer $x] && [string is integer $y]}
    } -result 1

    ################################################################

    test play_sound-1.0 {
        Play a system sound
    } -constraints {
        userInteraction
    } -body {
        twapi::play_sound SystemAsterisk -alias
        yesno "play_sound-1.0: Did you hear the SystemAsterisk sound?"
    } -result 1

    test play_sound-2.0 {
        Play a WAV file
    } -constraints {
        userInteraction
    } -body {
        twapi::play_sound chimes.wav
        yesno "play_sound-2.0: Did you hear the chimes.wav?"
    } -result 1

    test play_sound-3.0 {
        Play a sound asynchronously
    } -constraints {
        userInteraction
    } -body {
        list [expr {[lindex [time {twapi::play_sound SystemHand -alias -async}] 0] < 100000}] [yesno "play_sound-3.0: Did you hear a SystemHand sound?"]
    } -result {1 1}

    test play_sound-4.0 {
        Play a default sound in place of non-existent sound
    } -constraints {
        userInteraction
    } -body {
        twapi::play_sound nosuchfile.txt
        yesno "play_sound-4.0: Did you hear a sound?"
    } -result 1

    test play_sound-4.1 {
        Do not play a default sound in place of non-existent sound
    } -constraints {
        userInteraction
    } -body {
        twapi::play_sound nosuchfile.txt -nodefault
        yesno "Did you hear a sound?"
    } -result 0

    test play_sound-5.0 {
        Play a system sound (-wait)
    } -constraints {
        userInteraction
    } -body {
        twapi::play_sound SystemAsterisk -alias -wait
        yesno "Did you hear a SystemAsterisk?"
    } -result 1

    test play_sound-6.0 {
        Play a system sound without stopping ongoing sound
    } -constraints {
        userInteraction
    } -setup {
        set pid [exec [info nameofexecutable] testutil.tcl "twapi::play_sound chimes.wav -loop ; vwait forever" &]
    } -body {
        after 1000
        twapi::play_sound SystemAsterisk -alias -nostop
        yesno "play_sound-6.0: Did you hear continuous chimes WITH a SystemAsterisk?"
    } -cleanup {
        twapi::end_process $pid -force
    } -result 1

    test play_sound-7.0 {
        Play a system sound continuosly
    } -constraints {
        userInteraction
    } -body {
        twapi::play_sound chimes.wav -loop
        yesno "play_sound-7.0: Are you hearing continuous chimes?"
    } -cleanup {
        twapi::stop_sound
    } -result 1

    ################################################################

    test stop_sound-1.0 {
        Stop all sounds
    } -constraints {
        userInteraction
    } -setup {
        set played [twapi::play_sound SystemAsterisk -alias -loop]
    } -body {
        if {![yesno "stop_sound-1.0: Are you hearing continuous SystemAsterisk?"]} {
            error "Could not start sound"
        }
        twapi::stop_sound
        yesno "Has the sound now stopped?"
    } -result 1

    ################################################################

    test get_desktop_workarea-1.0 {
    } -constraints {
        nt
    } -body {
        set coords [twapi::get_desktop_workarea]
        foreach {left top right bottom} $coords break
        expr {[llength $coords] == 4 &&
              [string is integer -strict $left] &&
              [string is integer -strict $left] &&
              [string is integer -strict $left] &&
              [string is integer -strict $left] &&
              [string is integer -strict $left]}
    } -result 1

    ################################################################

    test get_desktop_wallpaper-1.0 {
    } -constraints {
        nt
    } -body {
        set path [twapi::get_desktop_wallpaper]
        expr {[string length $path] == 0 || [file exists $path]}
    } -result 1

    ################################################################

    test set_desktop_wallpaper-1.0 {
	Set desktop wallpaper
    } -constraints {
        nt systemmodificationok
    } -setup {
        set orig_path [twapi::get_desktop_wallpaper]
    } -body {
	# Note we do not ask user if wallpaper changed, because
	# windows will not change it immediately, if -persist is not
	# specified and originally desktop had no wallpaper at all
	set path [file join [tcltest::testsDirectory] bitmap.bmp]
	if {![file exists $path]} {
	    set path [file join [tcltest::testsDirectory] rctest bitmap.bmp]
	}
        twapi::set_desktop_wallpaper $path
	equal_paths $path [twapi::get_desktop_wallpaper]
    } -cleanup {
        twapi::set_desktop_wallpaper $orig_path
    } -result 1

    test set_desktop_wallpaper-1.1 {
    } -constraints {
        nt systemmodificationok userInteraction
    } -setup {
        set orig_path [twapi::get_desktop_wallpaper]
    } -body {
	set path [file join [tcltest::testsDirectory] bitmap.bmp]
	if {![file exists $path]} {
	    set path [file join [tcltest::testsDirectory] rctest bitmap.bmp]
	}
        twapi::set_desktop_wallpaper $path -persist
        yesno "Did the desktop change?"
    } -cleanup {
        twapi::set_desktop_wallpaper $orig_path -persist
    } -result 1

    ################################################################

    test get_display_devices-1.0 {
        Get display devices
    } -body {
        set devs [twapi::get_display_devices]
        foreach dev $devs {
            verify_kl_fields $dev {
                -description
                -desktop
                -disconnect
                -flags
                -id
                -key
                -mirroring
                -modespruned
                -multidriver
                -name
                -primary
                -remote
                -removable
                -vgacompatible
            }
        }
        expr {[llength $devs] > 0}
    } -result 1

    ################################################################

    test get_display_monitors-1.0 {
        Get display monitors
    } -body {
        set monitors [twapi::get_display_monitors]
        foreach monitor $monitors {
            verify_kl_fields $monitor {
                -description
                -flags
                -id
                -key
                -name
                -active
                -attached
            }
        }
        expr {[llength $monitors] > 0}
    } -result 1

    ###

    test get_display_monitors-2.0 {
        Get active display monitors
    } -body {
        set monitors [twapi::get_display_monitors -activeonly]
        set active true
        foreach monitor $monitors {
            verify_kl_fields $monitor {
                -description
                -flags
                -id
                -key
                -name
                -active
                -attached
            }
            set active [expr {$active && [twapi::kl_get $monitor -active]}]
        }
        expr {[llength $monitors] > 0 && $active}
    } -result 1

    ###

    test get_display_monitors-3.0 {
        Get display monitors for a display device
    } -setup {
        set devicename [twapi::kl_get [lindex [twapi::get_display_devices] 0] -name]
    } -body {
        set monitors [twapi::get_display_monitors -device $devicename]
        set allmatch true
        foreach monitor $monitors {
            verify_kl_fields $monitor {
                -description
                -flags
                -id
                -key
                -name
                -active
                -attached
            }
            if {![string match -nocase [string map {\\ \\\\} ${devicename}]* [twapi::kl_get $monitor -name]]} {
                set allmatch false
            }
        }
        # Note there is the possibility that llength might be 0 if this
        # is not the primary device. We ignore that for now
        expr {$allmatch && [llength $monitors] > 0}
    } -result 1

    ################################################################

    test get_display_monitor_from_window-1.0 {
        Get display monitor handle from window
    } -body {
        twapi::get_display_monitor_from_window [twapi::get_desktop_window]
    } -result {\d+\s+HMONITOR} -match regexp

    ###

    test get_display_monitor_from_window-1.1 {
        Get display monitor handle from Tk window path
    } -setup {
        package require Tk
    } -body {
        twapi::get_display_monitor_from_window .
    } -result {\d+\s+HMONITOR} -match regexp

    ###

    test get_display_monitor_from_window-2.0 {
        Get display monitor handle defaulting to nearest
    } -setup {
        package require Tk
    } -body {
        wm iconify .
        update
        twapi::get_display_monitor_from_window . -default nearest
    } -result {\d+\s+HMONITOR} -match regexp

    ###

    test get_display_monitor_from_window-3.0 {
        Get display monitor handle defaulting to primary display
    } -setup {
        package require Tk
    } -body {
        # MOve it off screen
        wm geometry . +20000+20000
        update
        twapi::get_display_monitor_from_window . -default primary
    } -result {\d+\s+HMONITOR} -match regexp


    ################################################################

    test get_display_monitor_from_point-1.0 {
        Get display monitor handle for a virtual screen point
    } -body {
        twapi::get_display_monitor_from_point 10 10
    } -result {\d+\s+HMONITOR} -match regexp

    ###

    test get_display_monitor_from_point-2.0 {
        Get display monitor handle defaulting to nearest
    } -body {
        twapi::get_display_monitor_from_point 10000 10000 -default nearest
    } -result {\d+\s+HMONITOR} -match regexp

    ###

    test get_display_monitor_from_point-3.0 {
        Get display monitor handle defaulting to primary display
    } -body {
        twapi::get_display_monitor_from_point 10000 10000 -default primary
    } -result {\d+\s+HMONITOR} -match regexp

    ################################################################

    test get_display_monitor_from_rect-1.0 {
        Get display monitor handle for a virtual screen rectangle
    } -body {
        twapi::get_display_monitor_from_rect {10 10 100 100}
    } -result {\d+\s+HMONITOR} -match regexp

    ###

    test get_display_monitor_from_rect-2.0 {
        Get display monitor handle defaulting to nearest
    } -body {
        twapi::get_display_monitor_from_rect {-10 -10 -20 -20} -default nearest
    } -result {\d+\s+HMONITOR} -match regexp

    ###

    test get_display_monitor_from_rect-3.0 {
        Get display monitor handle defaulting to primary display
    } -body {
        twapi::get_display_monitor_from_rect {-10 -10 -20 -20} -default primary
    } -result {\d+\s+HMONITOR} -match regexp

    ################################################################

    test get_display_monitor_info-1.0 {
        Get display monitor information
    } -body {
        verify_kl_fields [twapi::get_display_monitor_info [twapi::get_display_monitor_from_rect {10 10 100 100}]] {-extent -workarea -primary -name}
    } -result ""

    ################################################################

    test get_multiple_display_monitor_info-1.0 {
        Get display monitor information for all monitors
    } -body {
        set data [twapi::get_multiple_display_monitor_info]
        verify_list_kl_fields $data {-extent -workarea -primary -name}
        expr {[llength $data] >= 1}
    } -result 1

    ################################################################

    test get_input_idle_time-1.0 {
        Get elapsed time since last input event
    } -body {
        string is integer [twapi::get_input_idle_time]
    } -result 1

    ################################################################

    test configure_window_titlebar-1.0 {
        Configure title bar visiblity
    } -constraints {
        userInteraction
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        twapi::configure_window_titlebar $np_win -visible 0
        after 100;               # Let change take place
        set invisible [yesno "Is the notepad title bar HIDDEN?"]
        twapi::configure_window_titlebar $np_win -visible 1
        after 100;               # Let change take place
        set visible [yesno "Is the notepad title bar VISIBLE?"]
        list $invisible $visible
    } -cleanup {
        twapi::end_process $np_pid
    } -result {1 1}

    test configure_window_titlebar-2.0 {
        Configure title bar system menu
    } -constraints {
        userInteraction
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        twapi::configure_window_titlebar $np_win -sysmenu 0
        after 100;               # Let change take place
        set invisible [yesno "Is the notepad system menu HIDDEN?"]
        twapi::configure_window_titlebar $np_win -sysmenu 1
        after 100;               # Let change take place
        set visible [yesno "Is the notepad system menu VISIBLE?"]
        list $invisible $visible
    } -cleanup {
        twapi::end_process $np_pid
    } -result {1 1}

    test configure_window_titlebar-3.0 {
        Configure title bar minimize box
    } -constraints {
        userInteraction
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        twapi::configure_window_titlebar $np_win -minimizebox 0
        after 100;               # Let change take place
        set invisible [yesno "Is the notepad window minimize box HIDDEN or DISABLED?"]
        twapi::configure_window_titlebar $np_win -minimizebox 1
        after 100;               # Let change take place
        set visible [yesno "Is the notepad window minimize box VISIBLE?"]
        list $invisible $visible
    } -cleanup {
        twapi::end_process $np_pid
    } -result {1 1}

    test configure_window_titlebar-4.0 {
        Configure title bar maximize box
    } -constraints {
        userInteraction
    } -setup {
        set np_pid [notepad_exec]
        set np_win [notepad_top $np_pid]
    } -body {
        twapi::configure_window_titlebar $np_win -maximizebox 0
        after 100;               # Let change take place
        set invisible [yesno "Is the notepad window maximize box HIDDEN or DISABLED?"]
        twapi::configure_window_titlebar $np_win -maximizebox 1
        after 100;               # Let change take place
        set visible [yesno "Is the notepad window maximize box VISIBLE?"]
        list $invisible $visible
    } -cleanup {
        twapi::end_process $np_pid
    } -result {1 1}

    ################################################################

    test get_color_depth-1.0 {
        Get color depth of screen
    } -body {
        twapi::get_color_depth
    } -match oneof -result {8 16 24 32}

    test get_color_depth-1.1 {
        Get color depth of window
    } -body {
        twapi::get_color_depth [twapi::get_console_window]
    } -match oneof -result {8 16 24 32}


    ################################################################

    ::tcltest::cleanupTests
}

namespace delete ::twapi::ui::test










